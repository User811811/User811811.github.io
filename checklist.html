<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom styles for better UI/UX */
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .spinner {
            border-top-color: #14b8a6; /* teal-500 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        /* Style for printing to PDF */
        /* This .no-print class is for browser's native print, but we also use it for JS-based PDF export */
        @media print {
            body, html {
                background-color: #fff;
            }
            #controls, #export-button-container, .no-print {
                display: none !important;
            }
            #checklist-container {
                box-shadow: none;
                border: none;
                background-color: #fff;
            }
            body, h1, h2, h3, p, label, th, td {
                color: #000 !important;
            }
            thead {
                background-color: #f3f4f6 !important;
            }
            tr {
                border-color: #e5e7eb !important;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="toast" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl translate-x-full opacity-0 transition-all duration-300">
        <p>Checklist saved!</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-white">Integration Checklist</h1>
            <p class="text-gray-400 mt-2">Filter and Export a tailored checklist for Client Integrations.</p>
        </header>

        <main class="max-w-6xl mx-auto flex flex-col gap-8">
            <div id="controls" class="bg-gray-800 border border-gray-700 p-6 rounded-2xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-6 border-b border-gray-600 pb-3 text-white">Describe the Client's Setup</h2>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <label for="clientName" class="block text-sm font-medium text-gray-300 mb-1">Client Name</label>
                        <input type="text" id="clientName" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="accountId" class="block text-sm font-medium text-gray-300 mb-1">Account ID</label>
                        <input type="number" id="accountId" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="campaignId" class="block text-sm font-medium text-gray-300 mb-1">Campaign ID</label>
                        <input type="number" id="campaignId" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 text-white rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>

                <div id="filter-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    
                    <div>
                        <h3 class="font-semibold text-gray-200 mb-2">Integration Type(s):</h3>
                        <div id="filter-integration-type" class="space-y-2">
                            <div class="flex items-center"><input type="checkbox" id="utt" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="utt" class="ml-2 text-sm">Universal Tracking Tag</label></div>
                            <div class="flex items-center"><input type="checkbox" id="capi" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="capi" class="ml-2 text-sm">Conversions API</label></div>
                            <div class="flex items-center"><input type="checkbox" id="pla" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="pla" class="ml-2 text-sm">Page Load API</label></div>
                            <div class="flex items-center"><input type="checkbox" id="ftp" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="ftp" class="ml-2 text-sm">FTP / Email</label></div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold text-gray-200 mb-2">Conversion Type(s):</h3>
                        <div id="filter-conversion-type" class="space-y-2">
                            <div class="flex items-center"><input type="checkbox" id="sale" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="sale" class="ml-2 text-sm">Sale</label></div>
                            <div class="flex items-center"><input type="checkbox" id="app" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="app" class="ml-2 text-sm">App</label></div>
                            <div class="flex items-center"><input type="checkbox" id="chaining" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="chaining" class="ml-2 text-sm">Chaining</label></div>
                            <div class="flex items-center"><input type="checkbox" id="consent" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="consent" class="ml-2 text-sm">Consent Mode</label></div>
                            <div class="flex items-center"><input type="checkbox" id="shared" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="shared" class="ml-2 text-sm">Shared Events (Needs suggestions)</label></div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold text-gray-200 mb-2">Additional Datapoint(s):</h3>
                        <div id="filter-datapoints" class="space-y-2">
                            <div class="flex items-center"><input type="checkbox" id="customerId" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="customerId" class="ml-2 text-sm">Customer ID</label></div>
                            <div class="flex items-center"><input type="checkbox" id="customerEmail" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="customerEmail" class="ml-2 text-sm">Customer Email</label></div>
                            <div class="flex items-center"><input type="checkbox" id="customerStatus" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="customerStatus" class="ml-2 text-sm">Customer Status</label></div>
                            <div class="flex items-center"><input type="checkbox" id="orderDiscount" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="orderDiscount" class="ml-2 text-sm">Order Discount</label></div>
                            <div class="flex items-center"><input type="checkbox" id="promoCode" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="promoCode" class="ml-2 text-sm">Promo Code</label></div>
                            <div class="flex items-center"><input type="checkbox" id="currencyCode" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="currencyCode" class="ml-2 text-sm">Currency Code</label></div>
                            <div class="flex items-center"><input type="checkbox" id="custom" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500"><label for="custom" class="ml-2 text-sm">Custom Text/Numeric/Money/Date (Needs suggestions)</label></div>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-gray-200">Saved Checklists</h3>
                        <button id="save-checklist-btn" title="Save current checklist" class="text-sm bg-teal-600 hover:bg-teal-700 text-white py-1 px-3 rounded-md shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">Save</button>
                    </div>
                    <div id="history-list" class="space-y-2 max-h-[300px] overflow-y-auto bg-gray-900 p-3 rounded-md border border-gray-700">
                        <p class="text-gray-400 text-sm">No saved checklists.</p>
                    </div>
                    <button id="new-checklist-btn" class="text-sm bg-gray-600 hover:bg-gray-700 text-white py-1 px-3 rounded-md mt-2 w-full shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Start New Checklist</button>
                </div>
            </div>

            <div>
                <div id="checklist-container" class="bg-gray-800 border border-gray-700 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-3 text-white">Checklist</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-teal-400 uppercase tracking-wider w-1/2">Task</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-teal-400 uppercase tracking-wider w-1/6">Reviewed & Checked</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-teal-400 uppercase tracking-wider">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="checklist-body" class="bg-gray-800 divide-y divide-gray-700">
                                <tr>
                                    <td colspan="3" class="px-6 py-10 text-center text-gray-400">Select criteria to generate the checklist.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="export-button-container" class="mt-6 flex justify-end">
                    <button id="export-pdf" class="bg-teal-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg id="export-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        <div id="spinner" class="spinner h-5 w-5 mr-2 rounded-full border-2 border-t-2 border-white hidden"></div>
                        <span id="export-text">Export to PDF</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- GLOBAL STATE ---
            let currentLoadedChecklistId = null;
            const STORAGE_KEY = 'integrationChecklists';

            // --- DATA ---
            const checklistData = [
                { category: 'General & Gateway Settings', task: '"Site Definition" matches production domain', integrations: [], datapoints: [] },
                { category: 'General & Gateway Settings', task: '"Site Definition" does not have staging domains present', integrations: [], datapoints: [] },
                { category: 'General & Gateway Settings', task: '"Default Landing Page" matches production landing page', integrations: [], datapoints: [] },
                { category: 'General & Gateway Settings', task: '"Program Tracking Template" contains "im_ref={clickid}"', integrations: [], datapoints: [] },
                { category: 'General & Gateway Settings', task: '"Deep Linking" URLs are accurate', integrations: [], datapoints: [] },
                { category: 'Universal Tracking Tag Review', task: 'Click ID saved to "IR_{CampaignID}" cookie', integrations: ['UTT'], datapoints: [] },
                { category: 'Universal Tracking Tag Review', task: 'Landing Page URL persists querystring until cookie policy is accepted', integrations: ['UTT'], datapoints: [] },
                { category: 'Universal Tracking Tag Review', task: 'Click ID passed between domains when site transition occurs', integrations: ['UTT'], datapoints: [] },
                { category: 'Universal Tracking Tag Review', task: 'UTT loads under 3 seconds. Use Notes to log time taken', integrations: ['UTT'], datapoints: [] },
                { category: 'Universal Tracking Tag Review', task: 'Identify function invoked for anonymous users', integrations: ['UTT'], datapoints: [] },
                { category: 'Universal Tracking Tag Review', task: 'Identify function invoked for logged-in users', integrations: ['UTT'], datapoints: [] },
                { category: 'Conversion Payload Review', task: 'Logs contain no errors in relation to test events', integrations: [], datapoints: [] },
                { category: 'Conversion Payload Review', task: 'Referring URLs are accurate', integrations: [], datapoints: [] },       
                { category: 'Conversion Payload Review', task: 'SKU is accurate', integrations: [], datapoints: ['Sale'] },
                { category: 'Conversion Payload Review', task: 'Varying Quantities are present', integrations: [], datapoints: ['Sale'] },
                { category: 'Conversion Payload Review', task: 'Subtotal excludes Taxes, Shipping and Discounts', integrations: [], datapoints: ['Sale'] },
                { category: 'Conversion Payload Review', task: 'Subtotal rounded to 2 decimal places', integrations: [], datapoints: ['Sale'] },
                { category: 'Conversion Payload Review', task: 'OrderDiscount rounded to 2 decimal places', integrations: [], datapoints: ['Discount'] },
                { category: 'Conversion Payload Review', task: 'Promo Codes passed correctly', integrations: [], datapoints: ['Promo'] },
                { category: 'Conversion Payload Review', task: 'Currency Code passed correctly', integrations: [], datapoints: ['Currency'] },
                { category: 'Conversion Payload Review', task: 'Customer Status passed correctly', integrations: [], datapoints: ['Status'] },
                { category: 'End to End Tests', task: 'Production Tests include different SKUs', integrations: [], datapoints: ['Sale'] },
                { category: 'End to End Tests', task: 'Production Tests include varying Quantities', integrations: [], datapoints: ['Sale'] },
                { category: 'End to End Tests', task: 'Production Tests include a Promo Code', integrations: [], datapoints: ['Promo'] },
                { category: 'End to End Tests', task: 'Production Tests include Discounted Items', integrations: [], datapoints: ['Discount'] },
                { category: 'End to End Tests', task: 'Discounts are not duplicated', integrations: [], datapoints: ['Discount'] },
                { category: 'End to End Tests', task: 'Emails are SHA1 Hashed', integrations: [], datapoints: ['Email'] },
                { category: 'End to End Tests', task: 'Revenue & Payout verified by client', integrations: [], datapoints: ['Sale'] },
                { category: 'End to End Tests', task: 'Events have attributed to the correct Partner', integrations: [], datapoints: [] },
                { category: 'End to End Tests', task: 'Chained events are correctly chained (Referral Type: Action)', integrations: [], datapoints: ['Chained'] },
                { category: 'End to End Tests', task: '<a href="https://impact.atlassian.net/wiki/spaces/IE/pages/4813029543/How+to+validate+a+Consent+Mode+integration" class="text-teal-400 hover:text-teal-300">Consent Mode Integration reviewed.</a>', integrations: [], datapoints: ['Consent'] },
                { category: 'Modifications / Reversals', task: 'What method of reversals will the client be using? Answer in Notes', integrations: [], datapoints: [] },
                { category: 'Modifications / Reversals', task: 'Order level reversals have been tested', integrations: [], datapoints: [] },
                { category: 'Modifications / Reversals', task: 'Item level returns have been tested', integrations: [], datapoints: [] },
                { category: 'Operator & Checklist Cleanup', task: 'Complete "Impact Tech Review" step', integrations: [], datapoints: [] },
                { category: 'Operator & Checklist Cleanup', task: 'Any nuances added to Implementation Notes', integrations: [], datapoints: [] },
                { category: 'Operator & Checklist Cleanup', task: '"Has Mobile App"" is ticked', integrations: [], datapoints: ['App'] },
                { category: 'Operator & Checklist Cleanup', task: '"Integration Types" have been added to Operator', integrations: [], datapoints: [] },
            ];
            
            // Map checkbox labels to data values for easy lookup
            const filterMap = {
                // Labels to Values
                'Universal Tracking Tag': 'UTT', 'Conversions API': 'API', 'Page Load API': 'PLA', 'FTP / Email': 'FTP',
                'Sale': 'Sale', 'App': 'App', 'Chaining': 'Chained', 'Consent Mode': 'Consent', 'Shared Events': 'Shared',
                'Customer ID': 'ID', 'Customer Email': 'Email', 'Customer Status': 'Status', 'Order Discount': 'Discount',
                'Promo Code': 'Promo', 'Currency Code': 'Currency', 'Custom Text/Numeric/Money/Date': 'Custom',
            };
            
            // Map values back to DOM element IDs
            const reverseFilterMap = {
                // Values to IDs
                'UTT': 'utt', 'API': 'capi', 'PLA': 'pla', 'FTP': 'ftp',
                'Sale': 'sale', 'App': 'app', 'Chained': 'chaining', 'Consent': 'consent', 'Shared': 'shared',
                'ID': 'customerId', 'Email': 'customerEmail', 'Status': 'customerStatus', 'Discount': 'orderDiscount',
                'Promo': 'promoCode', 'Currency': 'currencyCode', 'Custom': 'custom'
            };

            // --- DOM ELEMENTS ---
            const filterForm = document.getElementById('filter-form');
            const checklistBody = document.getElementById('checklist-body');
            const chainingCheckbox = document.getElementById('chaining');
            const customerIdCheckbox = document.getElementById('customerId');
            const exportPdfButton = document.getElementById('export-pdf');
            const saveButton = document.getElementById('save-checklist-btn');
            const historyList = document.getElementById('history-list');
            const newChecklistButton = document.getElementById('new-checklist-btn');
            const clientNameInput = document.getElementById('clientName');
            const accountIdInput = document.getElementById('accountId');
            const campaignIdInput = document.getElementById('campaignId');

            // --- FUNCTIONS ---
            
            /**
             * Renders the checklist table based on the provided items.
             */
            function renderChecklist(items) {
                checklistBody.innerHTML = ''; // Clear existing rows
                if (items.length === 0) {
                    checklistBody.innerHTML = '<tr><td colspan="3" class="px-6 py-10 text-center text-gray-400">No checklist items match the selected criteria.</td></tr>';
                    return;
                }

                let currentCategory = '';
                items.forEach(item => {
                    if (item.category !== currentCategory) {
                        currentCategory = item.category;
                        const categoryRow = document.createElement('tr');
                        categoryRow.innerHTML = `
                            <td colspan="3" class="px-6 py-3 bg-gray-900 text-teal-300 font-bold">
                                <div class="flex justify-between items-center">
                                    <span>${currentCategory}</span>
                                    <button class="fast-fill-btn no-print text-xs bg-gray-600 hover:bg-gray-500 text-white py-1 px-2 rounded" data-category="${currentCategory}">
                                        Check All
                                    </button>
                                </div>
                            </td>`;
                        checklistBody.appendChild(categoryRow);
                    }

                    const taskRow = document.createElement('tr');
                    taskRow.classList.add('hover:bg-gray-700', 'task-row'); 
                    taskRow.dataset.category = currentCategory;
                    
                    // UPDATED TD for checkbox and Notes input
                    taskRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-normal text-sm text-gray-100">${item.task}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-center">
                            <input type="checkbox" class="status-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-teal-500 focus:ring-teal-500">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="text" class="notes-input w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-teal-500 focus:ring focus:ring-teal-500 focus:ring-opacity-50 px-3 py-1" placeholder="Add notes...">
                        </td>
                    `;
                    checklistBody.appendChild(taskRow);
                });

                addFastFillListeners();
            }

            /**
             * Adds event listeners to all "Check All" buttons.
             */
            function addFastFillListeners() {
                checklistBody.querySelectorAll('.fast-fill-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const category = button.dataset.category;
                        let nextElement = button.closest('tr').nextElementSibling;
                        
                        while (nextElement && !nextElement.querySelector('.fast-fill-btn')) {
                            if (nextElement.classList.contains('task-row') && nextElement.dataset.category === category) {
                                const checkbox = nextElement.querySelector('.status-checkbox');
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            }
                            nextElement = nextElement.nextElementSibling;
                        }
                    });
                });
            }
            
            /**
             * Filters the main checklist data based on selected criteria and triggers a re-render.
             */
            function filterAndRender() {
                const selectedFilters = new Set();
                const checkboxes = filterForm.querySelectorAll('input[type="checkbox"]:checked');
                
                checkboxes.forEach(cb => {
                    const label = cb.nextElementSibling.textContent;
                    if (filterMap[label]) {
                        selectedFilters.add(filterMap[label]);
                    }
                });

                if (selectedFilters.size === 0) {
                    checklistBody.innerHTML = '<tr><td colspan="3" class="px-6 py-10 text-center text-gray-400">Select criteria to generate the checklist.</td></tr>';
                    return;
                }

                const filteredData = checklistData.filter(item => {
                    if (item.integrations.length === 0 && item.datapoints.length === 0) return true;
                    const integrationMatch = item.integrations.length === 0 || item.integrations.some(req => selectedFilters.has(req));
                    const datapointMatch = item.datapoints.length === 0 || item.datapoints.some(req => selectedFilters.has(req));
                    return integrationMatch && datapointMatch;
                });
                
                renderChecklist(filteredData);
            }

            // --- LOCALSTORAGE FUNCTIONS ---

            function loadChecklistsFromStorage() {
                const checklists = localStorage.getItem(STORAGE_KEY);
                return checklists ? JSON.parse(checklists) : [];
            }

            function saveChecklistsToStorage(checklists) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(checklists));
            }

            function renderHistoryList() {
                const checklists = loadChecklistsFromStorage();
                historyList.innerHTML = ''; 

                if (checklists.length === 0) {
                    historyList.innerHTML = '<p class="text-gray-400 text-sm">No saved checklists.</p>';
                    return;
                }

                checklists.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                checklists.forEach(checklist => {
                    const item = document.createElement('div');
                    item.className = 'p-3 bg-gray-800 border border-gray-700 rounded-md flex justify-between items-center';
                    
                    const textContainer = document.createElement('div');
                    textContainer.className = 'cursor-pointer flex-grow overflow-hidden mr-2'; 
                    textContainer.onclick = () => loadChecklist(checklist.id);
                    
                    const client = document.createElement('p');
                    client.className = 'font-semibold text-teal-400 truncate'; 
                    client.textContent = checklist.clientName || 'Untitled Checklist';
                    
                    const details = document.createElement('p');
                    details.className = 'text-xs text-gray-400 truncate'; 
                    details.textContent = `Acct: ${checklist.accountId || 'N/A'} - Camp: ${checklist.campaignId || 'N/A'}`;

                    const details2 = document.createElement('p');
                    details2.className = 'text-xs text-gray-500 truncate'; 
                    details2.textContent = `Saved: ${new Date(checklist.timestamp).toLocaleString()}`

                    textContainer.appendChild(client);
                    textContainer.appendChild(details);
                    textContainer.appendChild(details2);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'p-1 text-gray-500 hover:text-red-400 focus:outline-none flex-shrink-0'; 
                    deleteBtn.title = 'Delete checklist';
                    deleteBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6zm2 2v6h2V8H9z" clip-rule="evenodd" /></svg>';
                    deleteBtn.onclick = () => deleteChecklist(checklist.id);
                    
                    item.appendChild(textContainer);
                    item.appendChild(deleteBtn);
                    historyList.appendChild(item);
                });
            }

            function saveCurrentChecklist() {
                const checklists = loadChecklistsFromStorage();
                
                const clientInfo = {
                    clientName: clientNameInput.value,
                    accountId: accountIdInput.value,
                    campaignId: campaignIdInput.value,
                };

                const selectedFilters = [];
                filterForm.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                    const label = cb.nextElementSibling.textContent;
                    if (filterMap[label]) {
                        selectedFilters.push(filterMap[label]);
                    }
                });

                const tasks = [];
                checklistBody.querySelectorAll('tr.task-row').forEach(row => {
                    const taskCell = row.querySelector('td:first-child');
                    if (!taskCell) return; 

                    tasks.push({
                        task: taskCell.innerHTML, 
                        status: row.querySelector('.status-checkbox').checked, 
                        notes: row.querySelector('.notes-input').value,
                    });
                });

                let checklist;
                let existingIndex = -1;

                if (currentLoadedChecklistId) {
                    existingIndex = checklists.findIndex(c => c.id === currentLoadedChecklistId);
                }

                if (existingIndex !== -1) {
                    checklist = { ...checklists[existingIndex], ...clientInfo, filters: selectedFilters, tasks: tasks, timestamp: new Date().toISOString() };
                    checklists[existingIndex] = checklist;
                } else {
                    const newId = Date.now().toString();
                    checklist = { ...clientInfo, id: newId, filters: selectedFilters, tasks: tasks, timestamp: new Date().toISOString() };
                    checklists.push(checklist);
                    currentLoadedChecklistId = newId; 
                }

                saveChecklistsToStorage(checklists);
                renderHistoryList();
                showToast('Checklist saved!', 'success'); 
            }

            function loadChecklist(id) {
                const checklists = loadChecklistsFromStorage();
                const checklist = checklists.find(c => c.id === id);
                if (!checklist) return;

                currentLoadedChecklistId = id; 

                clientNameInput.value = checklist.clientName || '';
                accountIdInput.value = checklist.accountId || '';
                campaignIdInput.value = checklist.campaignId || '';

                filterForm.removeEventListener('change', onFilterChange);
                
                filterForm.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false; 
                });
                
                checklist.filters.forEach(filterValue => {
                    const elementId = reverseFilterMap[filterValue];
                    if (elementId) {
                        const checkbox = document.getElementById(elementId);
                        if (checkbox) checkbox.checked = true;
                    }
                });
                
                filterAndRender(); 
                populateChecklistState(checklist.tasks);
                filterForm.addEventListener('change', onFilterChange);

                showToast('Checklist loaded!', 'info'); 
            }

            /**
             * Fills in the status and notes for the checklist table from a saved task list.
             * @param {Array} tasks - The array of saved task objects.
             */
            function populateChecklistState(tasks) {
                if (!tasks) return;
                
                checklistBody.querySelectorAll('tr.task-row').forEach(row => {
                    const taskCell = row.querySelector('td:first-child');
                    if (!taskCell) return; 

                    const taskHtml = taskCell.innerHTML;
                    const savedTask = tasks.find(t => t.task === taskHtml);

                    if (savedTask) {
                        row.querySelector('.status-checkbox').checked = savedTask.status; 
                        row.querySelector('.notes-input').value = savedTask.notes;
                    }
                });
            }

            function deleteChecklist(id) {
                if (!confirm('Are you sure you want to delete this saved checklist?')) return;

                let checklists = loadChecklistsFromStorage();
                checklists = checklists.filter(c => c.id !== id);
                saveChecklistsToStorage(checklists);
                
                renderHistoryList(); 
                showToast('Checklist deleted.', 'error'); 

                if (currentLoadedChecklistId === id) {
                    startNewChecklist(); 
                }
            }

            function startNewChecklist() {
                currentLoadedChecklistId = null;
                clientNameInput.value = '';
                accountIdInput.value = '';
                campaignIdInput.value = '';
                
                filterForm.removeEventListener('change', onFilterChange);
                filterForm.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                filterForm.addEventListener('change', onFilterChange);
                
                filterAndRender(); 
            }

            /**
             * Shows the toast notification with different types.
             * @param {string} message - The message to display.
             * @param {string} type - 'success' (teal), 'error' (red), or 'info' (blue).
             */
            function showToast(message, type = 'success') { 
                const toast = document.getElementById('toast');
                const toastText = toast.querySelector('p');
                
                toastText.textContent = message;

                toast.classList.remove('bg-teal-500', 'bg-red-500', 'bg-blue-500');

                if (type === 'success') {
                    toast.classList.add('bg-teal-500'); 
                } else if (type === 'error') {
                    toast.classList.add('bg-red-500'); 
                } else {
                    toast.classList.add('bg-blue-500'); 
                }

                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
                
                setTimeout(() => {
                    toast.classList.remove('translate-x-0', 'opacity-100');
                    toast.classList.add('translate-x-full', 'opacity-0');
                }, 2500); 
            }

            /**
             * Event handler for filter changes.
             */
            function onFilterChange() {
                currentLoadedChecklistId = null; 
                filterAndRender();
            }

            // --- EVENT LISTENERS ---

            filterForm.addEventListener('change', onFilterChange);
            
            chainingCheckbox.addEventListener('change', () => {
                if (chainingCheckbox.checked) {
                    customerIdCheckbox.checked = true;
                    currentLoadedChecklistId = null; 
                    filterAndRender();
                }
            });

            // LocalStorage Button Listeners
            saveButton.addEventListener('click', saveCurrentChecklist);
            
            newChecklistButton.addEventListener('click', () => { 
                startNewChecklist();
                showToast('New checklist started.', 'info');
            });
            
            // --- PDF EXPORT LOGIC (REBUILT) ---
            exportPdfButton.addEventListener('click', async () => {
                const clientName = clientNameInput.value || 'N/A';
                const accountId = accountIdInput.value || 'N/A';
                const campaignId = campaignIdInput.value || 'N/A';
                const checklistContainer = document.getElementById('checklist-container');
                const { jsPDF } = window.jspdf;

                exportPdfButton.disabled = true;
                document.getElementById('export-icon').classList.add('hidden');
                document.getElementById('spinner').classList.remove('hidden');
                document.getElementById('export-text').textContent = 'Generating...';
                
                // Hide .no-print buttons
                document.querySelectorAll('.no-print').forEach(el => el.style.display = 'none');

                try {
                    const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const pdfWidth = pdf.internal.pageSize.getWidth(); // 210mm
                    const pdfHeight = pdf.internal.pageSize.getHeight(); // 297mm
                    
                    // --- DEFINE LAYOUT CONSTANTS ---
                    const margin = 5; // 5mm margin
                    const footerHeight = 15; // 15mm for footer
                    const bgColor = '#1f2937'; // bg-gray-800
                    const footerTextColor = '#d1d5db'; // gray-300
                    const headerTextColor = '#ffffff'; // white
                    const subheaderTextColor = '#2dd4bf'; // teal-400
                    const bodyTextColor = '#d1d5db'; // gray-300
                    
                    // Calculate content area *inside* the margin
                    const contentX = margin;
                    const contentY = margin;
                    const contentWidth = pdfWidth - (margin * 2);
                    const contentHeight = pdfHeight - footerHeight - (margin * 2); // This is the usable height *for content*
                    
                    // --- ADD FOOTER FUNCTION ---
                    const addFooter = (pdfPage) => {
                        pdf.setPage(pdfPage);
                        // Draw solid footer rectangle
                        pdf.setFillColor(bgColor); // Same bg color
                        pdf.rect(0, pdfHeight - footerHeight, pdfWidth, footerHeight, 'F'); 
                        // Add footer text
                        pdf.setFontSize(9).setFont('helvetica', 'normal');
                        pdf.setTextColor(footerTextColor);
                        const footerText = `Client: ${clientName}  |  Account ID: ${accountId}  |  Campaign ID: ${campaignId}`;
                        pdf.text(footerText, pdfWidth / 2, pdfHeight - (footerHeight / 2) + 3, { align: 'center' }); // Center text in footer
                    };
                    
                    // --- ADD BACKGROUND FUNCTION ---
                    const addBackground = (pdfPage) => {
                        pdf.setPage(pdfPage);
                        pdf.setFillColor(bgColor);
                        pdf.rect(0, 0, pdfWidth, pdfHeight, 'F'); // 'F' = Fill
                    };

                    // --- GENERATE SUMMARY PAGE (PAGE 1) ---
                    addBackground(1);
                    
                    pdf.setFontSize(22).setFont('helvetica', 'bold');
                    pdf.setTextColor(headerTextColor);
                    pdf.text('Integration Checklist Summary', pdfWidth / 2, 30, { align: 'center' });

                    const timestamp = new Date().toLocaleString();
                    pdf.setFontSize(10).setFont('helvetica', 'normal');
                    pdf.setTextColor(footerTextColor);
                    pdf.text(`Generated on: ${timestamp}`, pdfWidth / 2, 40, { align: 'center' });

                    // --- Collect selected filters ---
                    const getSelectedFilters = (containerId) => {
                        const filters = [];
                        document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`).forEach(cb => {
                            filters.push(cb.nextElementSibling.textContent);
                        });
                        return filters.length > 0 ? filters : ['None Selected'];
                    };
                    
                    const integrationFilters = getSelectedFilters('filter-integration-type');
                    const conversionFilters = getSelectedFilters('filter-conversion-type');
                    const datapointFilters = getSelectedFilters('filter-datapoints');

                    let currentY = 60;
                    pdf.setFontSize(14).setFont('helvetica', 'bold');
                    pdf.setTextColor(subheaderTextColor);
                    pdf.text('Integration Type:', 20, currentY);
                    
                    pdf.setFontSize(10).setFont('helvetica', 'normal');
                    pdf.setTextColor(bodyTextColor);
                    currentY += 7;
                    integrationFilters.forEach(filter => {
                        pdf.text(`- ${filter}`, 25, currentY);
                        currentY += 6;
                    });
                    
                    currentY += 10;
                    pdf.setFontSize(14).setFont('helvetica', 'bold');
                    pdf.setTextColor(subheaderTextColor);
                    pdf.text('Conversion Type:', 20, currentY);
                    
                    pdf.setFontSize(10).setFont('helvetica', 'normal');
                    pdf.setTextColor(bodyTextColor);
                    currentY += 7;
                    conversionFilters.forEach(filter => {
                        pdf.text(`- ${filter}`, 25, currentY);
                        currentY += 6;
                    });

                    currentY += 10;
                    pdf.setFontSize(14).setFont('helvetica', 'bold');
                    pdf.setTextColor(subheaderTextColor);
                    pdf.text('Additional Datapoints:', 20, currentY);
                    
                    pdf.setFontSize(10).setFont('helvetica', 'normal');
                    pdf.setTextColor(bodyTextColor);
                    currentY += 7;
                    datapointFilters.forEach(filter => {
                        pdf.text(`- ${filter}`, 25, currentY);
                        currentY += 6;
                    });

                    addFooter(1);


                    // --- GENERATE CHECKLIST PAGES (PAGE 2+) ---
                    const canvas = await html2canvas(checklistContainer, {
                        scale: 2,
                        backgroundColor: bgColor,
                        onclone: (doc) => {
                            // NEW: This runs on the cloned document *before* capture
                            // Remove empty placeholders
                            doc.querySelectorAll('.notes-input').forEach(input => {
                                if (!input.value || !input.value.trim()) {
                                    input.placeholder = '';
                                }
                            });
                        }
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;

                    // Calculate the aspect ratio
                    const ratio = imgHeight / imgWidth;
                    
                    // Scale image height to the *contentWidth* (with margins)
                    const totalScaledImgHeight = contentWidth * ratio; 

                    // Calculate the pixel height of a *single page slice* in the canvas
                    const slicePixelHeight = (imgHeight / totalScaledImgHeight) * contentHeight;
                    
                    const totalPages = Math.ceil(totalScaledImgHeight / contentHeight);
                    let currentSliceY = 0; // The Y-position to start slicing from the *original canvas*
                    
                    for (let i = 0; i < totalPages; i++) {
                        pdf.addPage();
                        const pageNum = i + 2; // Start from page 2
                        
                        // Add Background and Footer for the *current* page
                        addBackground(pageNum);
                        addFooter(pageNum);

                        // Create a temporary canvas for the slice
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = imgWidth;
                        // Calculate the height of the current slice (could be less on the last page)
                        const currentSlicePixelHeight = Math.min(slicePixelHeight, imgHeight - currentSliceY);
                        if (currentSlicePixelHeight <= 0) continue;
                        
                        tempCanvas.height = currentSlicePixelHeight;
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        // Draw the slice from the master canvas onto the temp canvas
                        tempCtx.drawImage(canvas, 
                            0, currentSliceY, // Source X, Y
                            imgWidth, currentSlicePixelHeight, // Source W, H
                            0, 0, // Dest X, Y
                            imgWidth, currentSlicePixelHeight // Dest W, H
                        );
                        
                        const pageDataURL = tempCanvas.toDataURL('image/png');
                        
                        // Calculate the scaled height of this *specific slice*
                        const scaledSliceHeight = (currentSlicePixelHeight / imgHeight) * totalScaledImgHeight;
                        
                        // Add the slice image to the PDF, *inside* the margin
                        pdf.addImage(pageDataURL, 'PNG', contentX, contentY, contentWidth, scaledSliceHeight); 
                        
                        // Move our slice position down
                        currentSliceY += slicePixelHeight;
                    }

                    pdf.save(`${clientName.replace(/\s+/g, '_')}_Integration_Checklist.pdf`);

                } catch (error) {
                    console.error("Failed to generate PDF:", error);
                    alert("An error occurred while generating the PDF. Please check the console for details.");
                } finally {
                    exportPdfButton.disabled = false;
                    document.getElementById('spinner').classList.add('hidden');
                    document.getElementById('export-icon').classList.remove('hidden');
                    document.getElementById('export-text').textContent = 'Export to PDF';

                    // Show .no-print buttons again
                    document.querySelectorAll('.no-print').forEach(el => el.style.display = '');
                }
            });


            // --- INITIALIZATION ---
            renderHistoryList(); // Load and display any saved checklists on page load
        });
    </script>

</body>
</html>
