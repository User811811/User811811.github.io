<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Checklist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for filter pills */
        .filter-pill-button.active {
            background-color: #14B8A6; /* teal-500 */
            color: white;
            border-color: #0F766E; /* teal-700 */
        }
        .filter-pill-button.active .filter-dot {
            background-color: white;
        }
        /* Custom styles for status pills */
        .status-pill-button.checked {
            background-color: #22C55E; /* green-500 */
            color: white;
            border-color: #15803D; /* green-700 */
        }
        .status-pill-button.checked .status-dot {
            background-color: white;
        }
        /* Custom style for disabled inputs within buttons */
        #autosave-toggle-btn input:disabled {
            background-color: #4B5563; /* gray-600 */
            cursor: not-allowed;
        }
        /* Hide scrollbar for textarea, but allow scrolling */
        textarea.notes-input {
            overflow: hidden;
            resize: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

    <div class="p-4 sm:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold tracking-tight text-white">Integration Checklist</h1>
            <p class="mt-2 text-lg text-gray-400">Manage client integration tasks with ease.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Panel: Controls -->
            <section class="lg:col-span-1 bg-gray-800 p-6 rounded-2xl shadow-lg space-y-6">
                <!-- Client Info -->
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-white">Client Info</h2>
                    <div class="space-y-4">
                        <input type="text" id="client-name" placeholder="Client Name" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        <input type="text" id="account-id" placeholder="Account ID" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                        <input type="text" id="campaign-id" placeholder="Campaign ID *" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition">
                    </div>
                </div>

                <!-- Filters -->
                <div id="filters-container" class="space-y-6"></div>

                <!-- Saved Checklists -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">Your Saved Checklists</h2>
                    </div>
                    <div id="history-list" class="max-h-[300px] overflow-y-auto bg-gray-900/50 p-3 rounded-lg space-y-2 border border-gray-700">
                        <!-- History items will be injected here -->
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col space-y-3">
                     <button id="new-checklist-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center">Start New Checklist</button>
                     <button id="save-checklist-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-center">Save Current Checklist</button>
                    <button id="autosave-toggle-btn" class="flex items-center justify-between w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                        <div class="flex items-center gap-2">
                             <span>Auto-Save</span>
                             <input type="number" id="autosave-interval" value="5" min="1" class="w-12 text-center bg-gray-700 rounded text-white" disabled>
                             <span>min</span>
                        </div>
                        <span id="autosave-status" class="font-semibold">Off</span>
                    </button>
                    <button id="save-on-change-toggle-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-between">
                         <span>Save on Change</span>
                         <span id="save-on-change-status" class="font-semibold">Off</span>
                    </button>
                    <button id="delete-all-btn" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 flex items-center justify-between disabled:bg-gray-500 disabled:cursor-not-allowed">
                        <span>Delete All Saved Checklists</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                   </button>
                </div>

                 <!-- Export Button -->
                <button id="export-pdf-btn" disabled class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <svg id="export-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span id="export-text">Export to PDF</span>
                    <svg id="export-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </section>

            <!-- Right Panel: Checklist -->
            <section class="lg:col-span-2 bg-gray-800 p-6 rounded-2xl shadow-lg">
                <div id="checklist-container" class="overflow-x-auto">
                     <h2 class="text-2xl font-bold mb-4 text-white">Checklist</h2>
                    <table class="w-full text-sm text-left text-gray-400">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 w-1/2">Task</th>
                                <th scope="col" class="px-6 py-3 w-1/6 text-center">Status</th>
                                <th scope="col" class="px-6 py-3">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="checklist-body">
                            <!-- Checklist items will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const { jsPDF } = window.jspdf;

    // --- DATA ---
    const checklistData = [
        { category: 'General & Gateway Settings', task: '"Site Definition" matches production domain', integrations: [], conversions:[], datapoints: [] },
        { category: 'General & Gateway Settings', task: '"Site Definition" does not have staging domains present', integrations: [], conversions:[], datapoints: [] },
        { category: 'General & Gateway Settings', task: '"Default Landing Page" matches production landing page', integrations: [], conversions:[], datapoints: [] },
        { category: 'General & Gateway Settings', task: '"Program Tracking Template" contains "im_ref={clickid}"', integrations: [], conversions:[], datapoints: [] },
        { category: 'General & Gateway Settings', task: '"Deep Linking" URLs are accurate', integrations: [], conversions:[], datapoints: [] },
        { category: 'Universal Tracking Tag Review', task: 'Click ID saved to "IR_{CampaignID}" cookie', integrations: ['UTT'], conversions:[], datapoints: [] },
        { category: 'Universal Tracking Tag Review', task: 'Landing Page URL persists querystring until cookie policy is accepted, if applicable', integrations: ['UTT'], conversions:[], datapoints: [] },
        { category: 'Universal Tracking Tag Review', task: 'Click ID passed between domains when site transition occurs', integrations: ['UTT'], conversions:['CrossDomain'], datapoints: [] },
        { category: 'Universal Tracking Tag Review', task: 'UTT loads under 3 seconds, use Notes to log time taken', integrations: ['UTT'], conversions:[], datapoints: [] },
        { category: 'Universal Tracking Tag Review', task: 'Identify function invoked for anonymous users', integrations: ['UTT'], conversions:[], datapoints: [] },
        { category: 'Universal Tracking Tag Review', task: 'Identify function invoked for logged-in users', integrations: ['UTT'], conversions:[], datapoints: [] },
        { category: 'Conversion Payload Review', task: 'Logs contain no errors in relation to test events', integrations: [], conversions:[], datapoints: [] },
        { category: 'Conversion Payload Review', task: 'Referring URLs are accurate', integrations: [], conversions:[], datapoints: [] },
        { category: 'Conversion Payload Review', task: 'SKU is accurate', integrations: [], conversions:['Sale'], datapoints: [] },
        { category: 'Conversion Payload Review', task: 'Varying Quantities are present', integrations: [], conversions:['Sale'], datapoints: [] },
        { category: 'Conversion Payload Review', task: 'Subtotal excludes Taxes, Shipping and Discounts', integrations: [], conversions:['Sale'], datapoints: [] },
        { category: 'Conversion Payload Review', task: 'Subtotal rounded to 2 decimal places', integrations: [], conversions:['Sale'], datapoints: [] },
        { category: 'Conversion Payload Review', task: 'OrderDiscount rounded to 2 decimal places', integrations: [], conversions:[], datapoints: ['Discount'] },
        { category: 'Conversion Payload Review', task: 'Promo Codes passed correctly', integrations: [], conversions:[], datapoints: ['Promo'] },
        { category: 'Conversion Payload Review', task: 'Currency Code passed correctly', integrations: [], conversions:[], datapoints: ['Currency'] },
        { category: 'Conversion Payload Review', task: 'Customer Status passed correctly', integrations: [], conversions:[], datapoints: ['Status'] },
        { category: 'End to End Tests', task: 'Production Tests include different SKUs', integrations: [], conversions:['Sale'], datapoints: [] },
        { category: 'End to End Tests', task: 'Production Tests include varying Quantities', integrations: [], conversions:['Sale'], datapoints: [] },
        { category: 'End to End Tests', task: 'Production Tests include a Promo Code', integrations: [], conversions:[], datapoints: ['Promo'] },
        { category: 'End to End Tests', task: 'Production Tests include Discounted Items', integrations: [], conversions:[], datapoints: ['Discount'] },
        { category: 'End to End Tests', task: 'Discounts are not duplicated', integrations: [], conversions:[], datapoints: ['Discount'] },
        { category: 'End to End Tests', task: 'Emails are SHA1 Hashed', integrations: [], conversions:[], datapoints: ['Email'] },
        { category: 'End to End Tests', task: 'Revenue & Payout verified by client', integrations: [], conversions:['Sale'], datapoints: [] },
        { category: 'End to End Tests', task: 'Events have attributed to the correct Partner', integrations: [], conversions:[], datapoints: [] },
        { category: 'End to End Tests', task: 'Chained events are correctly chained (Referral Type: Action)', integrations: [], conversions:['Chaining'], datapoints: [] },
        { category: 'End to End Tests', task: '<a href="https://impact.atlassian.net/wiki/spaces/IE/pages/4813029543/How+to+validate+a+Consent+Mode+integration" target="_blank" rel="noopener noreferrer" class="text-teal-400 hover:text-teal-300">Consent Mode Integration reviewed.</a>', integrations: [], conversions:['Consent'], datapoints: [] },
        { category: 'Modifications / Reversals', task: 'What method of reversals will the client be using? Answer in Notes', integrations: [], conversions:[], datapoints: [] },
        { category: 'Modifications / Reversals', task: 'Order level reversals have been tested', integrations: [], conversions:[], datapoints: [] },
        { category: 'Modifications / Reversals', task: 'Item level returns have been tested', integrations: [], conversions:[], datapoints: [] },
        { category: 'Operator & Checklist Cleanup', task: 'Complete "Impact Tech Review" step', integrations: [], conversions:[], datapoints: [] },
        { category: 'Operator & Checklist Cleanup', task: 'Any nuances added to Implementation Notes', integrations: [], conversions:[], datapoints: [] },
        { category: 'Operator & Checklist Cleanup', task: '"Has Mobile App" is ticked', integrations: [], conversions:['App'], datapoints: [] },
        { category: 'Operator & Checklist Cleanup', task: '"Integration Types" have been added to Operator', integrations: [], conversions:[], datapoints: [] },
    ];

    const filterDefinitions = {
        integrations: {
            title: "Integration Type(s)",
            items: {
                UTT: "Universal Tracking Tag",
                CAPI: "Conversions API",
                PageLoad: "Page Load API",
                FTP: "FTP / Email"
            }
        },
        conversions: {
            title: "Conversion Type(s)",
            items: {
                Sale: "Sale",
                App: "App",
                Chaining: "Chaining",
                Consent: "Consent Mode",
                CrossDomain: "Cross Domain Tracking",
                SharedEvents: "Shared Events (Needs suggestions)"
            }
        },
        datapoints: {
            title: "Additional Datapoint(s)",
            items: {
                CustomerID: "Customer ID",
                Email: "Customer Email",
                Status: "Customer Status",
                Discount: "Order Discount",
                Promo: "Promo Code",
                Currency: "Currency Code",
                Custom: "Custom Text/Numeric/Money/Date (Needs suggestions)"
            }
        }
    };

    // --- STATE ---
    let currentLoadedChecklistId = null;
    let autoSaveTimer = null;
    let saveOnChangeTimer = null;
    let isAutoSaveOn = false;
    let isSaveOnChangeOn = false;

    // --- DOM ELEMENTS ---
    const clientNameInput = document.getElementById('client-name');
    const accountIdInput = document.getElementById('account-id');
    const campaignIdInput = document.getElementById('campaign-id');
    const filtersContainer = document.getElementById('filters-container');
    const checklistBody = document.getElementById('checklist-body');
    const historyList = document.getElementById('history-list');
    const newChecklistBtn = document.getElementById('new-checklist-btn');
    const saveChecklistBtn = document.getElementById('save-checklist-btn');
    const autosaveToggleBtn = document.getElementById('autosave-toggle-btn');
    const autosaveStatus = document.getElementById('autosave-status');
    const autosaveIntervalInput = document.getElementById('autosave-interval');
    const saveOnChangeToggleBtn = document.getElementById('save-on-change-toggle-btn');
    const saveOnChangeStatus = document.getElementById('save-on-change-status');
    const exportPdfBtn = document.getElementById('export-pdf-btn');
    const exportText = document.getElementById('export-text');
    const exportSpinner = document.getElementById('export-spinner');
    const toastContainer = document.getElementById('toast-container');
    const deleteAllBtn = document.getElementById('delete-all-btn');
    
    // --- TOAST NOTIFICATIONS ---
    const showToast = (message, type = 'info') => {
        const colors = {
            success: 'bg-teal-500',
            error: 'bg-red-500',
            info: 'bg-blue-500'
        };
        const toast = document.createElement('div');
        toast.className = `transform transition-all duration-300 opacity-0 translate-x-12 p-4 rounded-lg shadow-lg text-white ${colors[type]}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-x-12');
            toast.classList.add('opacity-100', 'translate-x-0');
        }, 10);

        // Animate out
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-x-0');
            toast.classList.add('opacity-0', 'translate-x-12');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 4000);
    };

    // --- RENDERING ---
    const renderFilters = () => {
        filtersContainer.innerHTML = '';
        for (const [key, filterGroup] of Object.entries(filterDefinitions)) {
            const groupDiv = document.createElement('div');
            groupDiv.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-white">${filterGroup.title}</h3>`;
            const itemsDiv = document.createElement('div');
            itemsDiv.className = 'space-y-2';
            itemsDiv.dataset.filterGroup = key;

            for (const [itemKey, itemValue] of Object.entries(filterGroup.items)) {
                const buttonId = `filter-${key}-${itemKey}`;
                const pillHtml = `
                    <label for="${buttonId}" class="filter-pill-button flex items-center w-full p-2 border-2 border-gray-600 rounded-full cursor-pointer transition hover:bg-gray-700">
                        <input type="checkbox" id="${buttonId}" data-filter-key="${itemKey}" class="hidden">
                        <span class="filter-dot w-3 h-3 bg-gray-500 rounded-full mr-3 ml-1"></span>
                        <span class="text-sm">${itemValue}</span>
                    </label>
                `;
                itemsDiv.innerHTML += pillHtml;
            }
            groupDiv.appendChild(itemsDiv);
            filtersContainer.appendChild(groupDiv);
        }
    };
    
    const renderChecklist = () => {
        const activeFilters = getActiveFilters();
        const activeIntegrationFilters = activeFilters.integrations;
        const activeConversionFilters = activeFilters.conversions;
        const activeDatapointFilters = activeFilters.datapoints;

        const filteredData = checklistData.filter(item => {
            const isGeneral = item.integrations.length === 0 && item.conversions.length === 0 && item.datapoints.length === 0;
            if (isGeneral) return true;

            const noFiltersSelected = activeIntegrationFilters.length === 0 && activeConversionFilters.length === 0 && activeDatapointFilters.length === 0;
            if (noFiltersSelected) return false;

            const requiredFilters = [...item.integrations, ...item.conversions, ...item.datapoints];
            const allActiveFilters = [...activeIntegrationFilters, ...activeConversionFilters, ...activeDatapointFilters];

            // Item is shown if all its required filters are present in the active filters list
            const allRequirementsMet = requiredFilters.every(req => allActiveFilters.includes(req));

            return allRequirementsMet;
        });

        const groupedData = filteredData.reduce((acc, item) => {
            if (!acc[item.category]) {
                acc[item.category] = [];
            }
            acc[item.category].push(item);
            return acc;
        }, {});

        checklistBody.innerHTML = '';
        for (const category in groupedData) {
            const categoryRow = document.createElement('tr');
            categoryRow.className = 'bg-gray-700/50';
            categoryRow.innerHTML = `
                <td colspan="3" class="px-6 py-3 font-bold text-teal-400">
                    <div class="flex justify-between items-center">
                        <span>${category}</span>
                        <div class="space-x-2">
                             <button data-category="${category}" class="check-all-btn text-xs bg-green-800/50 hover:bg-green-700/50 px-2 py-1 rounded-md">Check All</button>
                             <button data-category="${category}" class="uncheck-all-btn text-xs bg-gray-600/50 hover:bg-gray-500/50 px-2 py-1 rounded-md">Uncheck All</button>
                        </div>
                    </div>
                </td>
            `;
            checklistBody.appendChild(categoryRow);

            groupedData[category].forEach(item => {
                const itemRow = document.createElement('tr');
                itemRow.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-700/50';
                itemRow.dataset.task = item.task;
                itemRow.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-200">${item.task}</td>
                    <td class="px-6 py-4 text-center">
                        <button class="status-pill-button w-full flex items-center justify-center py-1 px-3 border-2 border-gray-600 rounded-full cursor-pointer transition">
                            <span class="status-dot w-2.5 h-2.5 bg-gray-400 rounded-full mr-2"></span>
                            <span class="status-text text-xs min-w-[68px] text-left">Not Checked</span>
                        </button>
                    </td>
                    <td class="px-6 py-4">
                        <textarea class="notes-input w-full bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-white placeholder-gray-500 focus:ring-1 focus:ring-teal-500 focus:border-teal-500 text-sm" rows="1"></textarea>
                    </td>
                `;
                checklistBody.appendChild(itemRow);
            });
        }
    };
    
    const renderHistory = () => {
        const checklists = getSavedChecklists();
        historyList.innerHTML = '';
        deleteAllBtn.disabled = checklists.length === 0;

        if (checklists.length === 0) {
            historyList.innerHTML = '<p class="text-gray-500 text-center text-sm p-4">No saved checklists yet.</p>';
            return;
        }

        checklists.sort((a, b) => new Date(b.lastSaved) - new Date(a.lastSaved));

        checklists.forEach(checklist => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bg-gray-700/50 p-3 rounded-lg flex justify-between items-center hover:bg-gray-700 transition';
            const date = new Date(checklist.lastSaved).toLocaleString();
            itemDiv.innerHTML = `
                <div class="flex-grow cursor-pointer" data-id="${checklist.id}">
                    <p class="font-semibold text-white">${checklist.clientName || 'Unnamed Checklist'}</p>
                    <p class="text-xs text-gray-400">AC: ${checklist.accountId || 'N/A'} | C: ${checklist.campaignId || 'N/A'}</p>
                    <p class="text-xs text-gray-500">Last Saved: ${date}</p>
                </div>
                <button data-id="${checklist.id}" class="delete-checklist-btn ml-4 text-red-500 hover:text-red-400 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
            `;
            historyList.appendChild(itemDiv);
        });
    };

    // --- STATE MANAGEMENT ---
    const getSavedChecklists = () => {
        return JSON.parse(localStorage.getItem('integrationChecklists') || '[]');
    };

    const saveChecklists = (checklists) => {
        localStorage.setItem('integrationChecklists', JSON.stringify(checklists));
    };

    const getActiveFilters = () => {
        const activeFilters = { integrations: [], conversions: [], datapoints: [] };
        document.querySelectorAll('#filters-container input[type="checkbox"]:checked').forEach(checkbox => {
            const group = checkbox.closest('[data-filter-group]').dataset.filterGroup;
            const key = checkbox.dataset.filterKey;
            if (group && key) {
                activeFilters[group].push(key);
            }
        });
        return activeFilters;
    };
    
    const getCurrentState = () => {
        const tasks = {};
        document.querySelectorAll('#checklist-body tr[data-task]').forEach(row => {
            const task = row.dataset.task;
            const statusPill = row.querySelector('.status-pill-button');
            const notesInput = row.querySelector('.notes-input');
            tasks[task] = {
                status: statusPill.classList.contains('checked') ? 'Checked' : 'Not Checked',
                notes: notesInput.value,
            };
        });

        return {
            id: currentLoadedChecklistId || Date.now(),
            clientName: clientNameInput.value,
            accountId: accountIdInput.value,
            campaignId: campaignIdInput.value,
            lastSaved: new Date().toISOString(),
            filters: getActiveFilters(),
            tasks: tasks,
        };
    };

    const loadState = (state) => {
        startNewChecklist();
        currentLoadedChecklistId = state.id;
        clientNameInput.value = state.clientName;
        accountIdInput.value = state.accountId;
        campaignIdInput.value = state.campaignId;

        // Set filters
        document.querySelectorAll('#filters-container input[type="checkbox"]').forEach(cb => {
            const group = cb.closest('[data-filter-group]').dataset.filterGroup;
            const key = cb.dataset.filterKey;
            cb.checked = state.filters[group]?.includes(key) || false;
            updatePillAppearance(cb);
        });

        renderChecklist();
        
        // Populate tasks
        document.querySelectorAll('#checklist-body tr[data-task]').forEach(row => {
            const taskKey = row.dataset.task;
            if (state.tasks[taskKey]) {
                const { status, notes } = state.tasks[taskKey];
                const statusPill = row.querySelector('.status-pill-button');
                const notesInput = row.querySelector('.notes-input');
                
                if (status === 'Checked') {
                    statusPill.classList.add('checked');
                    statusPill.querySelector('.status-text').textContent = 'Checked';
                }
                notesInput.value = notes;
                autoResizeTextarea(notesInput); // Resize on load
            }
        });

        // Enable/disable export button
        exportPdfBtn.disabled = !campaignIdInput.value.trim();
        showToast('Checklist loaded successfully.', 'success');
    };

    // --- CORE FUNCTIONS ---
    const startNewChecklist = () => {
        currentLoadedChecklistId = null;
        clientNameInput.value = '';
        accountIdInput.value = '';
        campaignIdInput.value = '';
        
        document.querySelectorAll('#filters-container input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
            updatePillAppearance(cb);
        });
        
        stopAutoSave();
        stopSaveOnChange();

        renderChecklist();
        exportPdfBtn.disabled = true;
    };

    const saveCurrentChecklist = () => {
        if (!campaignIdInput.value.trim()) {
            showToast('Campaign ID is required to save.', 'error');
            return false;
        }

        const currentState = getCurrentState();
        const checklists = getSavedChecklists();
        const existingIndex = checklists.findIndex(c => c.id === currentState.id);

        if (existingIndex > -1) {
            checklists[existingIndex] = currentState;
        } else {
            checklists.push(currentState);
            currentLoadedChecklistId = currentState.id;
        }

        saveChecklists(checklists);
        renderHistory();
        showToast('Checklist saved!', 'success');
        return true;
    };

    const deleteChecklist = (id) => {
        let checklists = getSavedChecklists();
        checklists = checklists.filter(c => c.id !== id);
        saveChecklists(checklists);
        renderHistory();

        if(currentLoadedChecklistId === id){
            startNewChecklist();
        }
        showToast('Checklist deleted.', 'info');
    };

    // --- AUTO-SAVE LOGIC ---
    const debouncedSave = () => {
        clearTimeout(saveOnChangeTimer);
        saveOnChangeTimer = setTimeout(() => {
            if (campaignIdInput.value.trim()) {
                saveCurrentChecklist();
            }
        }, 750);
    };

    const startAutoSave = () => {
        stopSaveOnChange();
        if (autoSaveTimer) clearInterval(autoSaveTimer);

        const intervalMinutes = parseInt(autosaveIntervalInput.value, 10);
        if (isNaN(intervalMinutes) || intervalMinutes < 1) {
            showToast('Invalid auto-save interval.', 'error');
            return;
        }

        isAutoSaveOn = true;
        autosaveToggleBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        autosaveToggleBtn.classList.add('bg-teal-600', 'hover:bg-teal-700');
        autosaveStatus.textContent = 'On';
        autosaveIntervalInput.disabled = false;

        autoSaveTimer = setInterval(() => {
             if (campaignIdInput.value.trim()) {
                saveCurrentChecklist();
            }
        }, intervalMinutes * 60 * 1000);

        showToast(`Auto-save enabled every ${intervalMinutes} minute(s).`, 'info');
    };
    
    const stopAutoSave = () => {
        if (autoSaveTimer) clearInterval(autoSaveTimer);
        autoSaveTimer = null;
        isAutoSaveOn = false;
        autosaveToggleBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
        autosaveToggleBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
        autosaveStatus.textContent = 'Off';
        autosaveIntervalInput.disabled = true;
    };
    
    const startSaveOnChange = () => {
        stopAutoSave();
        isSaveOnChangeOn = true;
        saveOnChangeToggleBtn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
        saveOnChangeToggleBtn.classList.add('bg-teal-600', 'hover:bg-teal-700');
        saveOnChangeStatus.textContent = 'On';
        showToast('Save on change enabled.', 'info');
    };
    
    const stopSaveOnChange = () => {
        isSaveOnChangeOn = false;
        saveOnChangeToggleBtn.classList.add('bg-gray-600', 'hover:bg-gray-700');
        saveOnChangeToggleBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
        saveOnChangeStatus.textContent = 'Off';
    };


    // --- UI HELPERS ---
    const updatePillAppearance = (checkbox) => {
        const label = checkbox.closest('label');
        if (checkbox.checked) {
            label.classList.add('active');
        } else {
            label.classList.remove('active');
        }
    };

    const autoResizeTextarea = (textarea) => {
        textarea.style.height = 'auto';
        textarea.style.height = `${textarea.scrollHeight}px`;
    };

    // --- PDF EXPORT ---
    const exportToPDF = async () => {
        exportPdfBtn.disabled = true;
        exportText.textContent = 'Generating...';
        exportSpinner.classList.remove('hidden');

        try {
            const clientName = clientNameInput.value.trim();
            const accountId = accountIdInput.value.trim();
            const campaignId = campaignIdInput.value.trim();

            let filename = `(${campaignId}) - Integration Final Review.pdf`;
            if (clientName && accountId && campaignId) {
                filename = `${clientName} (${accountId} -> ${campaignId}) - Integration Final Review.pdf`;
            }

            const doc = new jsPDF({
                orientation: 'p',
                unit: 'pt',
                format: 'a4'
            });

            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;

            // --- Page 1: Summary ---
            const addFooter = (pageNum) => {
                doc.setFontSize(8);
                doc.setTextColor(150);
                const footerText = `Client: ${clientName || 'N/A'} | Account: ${accountId || 'N/A'} | Campaign: ${campaignId}`;
                doc.text(footerText, margin, pageHeight - 20);
                doc.text(`Page ${pageNum}`, pageWidth - margin, pageHeight - 20, { align: 'right' });
            };
            
            // Background
            doc.setFillColor(17, 24, 39); // gray-900
            doc.rect(0, 0, pageWidth, pageHeight, 'F');

            // Title
            doc.setFontSize(28);
            doc.setTextColor(255, 255, 255);
            doc.text('Integration Review Summary', pageWidth / 2, 60, { align: 'center' });

            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text(new Date().toLocaleString(), pageWidth / 2, 80, { align: 'center' });
            
            let yPos = 140;

            const activeFilters = getActiveFilters();
            for (const [groupKey, groupDef] of Object.entries(filterDefinitions)) {
                const selectedItems = activeFilters[groupKey].map(key => groupDef.items[key]);
                if (selectedItems.length > 0) {
                    doc.setFontSize(14);
                    doc.setTextColor(20, 184, 166); // teal-500
                    doc.text(groupDef.title, margin, yPos);
                    yPos += 20;

                    doc.setFontSize(10);
                    doc.setTextColor(200);
                    selectedItems.forEach(item => {
                        doc.text(`- ${item}`, margin + 15, yPos);
                        yPos += 15;
                    });
                    yPos += 20;
                }
            }
            
            addFooter(1);


            // --- Page 2+: Checklist ---
            const canvas = await html2canvas(document.querySelector("#checklist-container"), {
                scale: 2,
                backgroundColor: '#111827', // bg-gray-900
                onclone: (clonedDoc) => {
                    // CRITICAL FIX 1: Set text colors for visibility
                    clonedDoc.querySelectorAll('h2, th').forEach(el => el.style.color = '#14B8A6'); // teal
                    clonedDoc.querySelectorAll('td').forEach(el => el.style.color = '#E5E7EB'); // gray-200
                    clonedDoc.querySelectorAll('a').forEach(el => el.style.color = '#2DD4BF'); // teal-400
                    
                    // CRITICAL FIX 2: Replace status pills with simple text
                    clonedDoc.querySelectorAll('.status-pill-button').forEach(pill => {
                        const isChecked = pill.classList.contains('checked');
                        const statusSpan = clonedDoc.createElement('span');
                        statusSpan.textContent = isChecked ? 'Checked' : 'Not Checked';
                        statusSpan.style.color = isChecked ? '#22C55E' : '#9CA3AF'; // green-500 or gray-400
                        statusSpan.style.fontWeight = 'bold';
                        pill.parentNode.replaceChild(statusSpan, pill);
                    });
                }
            });

            const imgData = canvas.toDataURL('image/png');
            const imgWidth = pageWidth - margin * 2;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;
            let pageNum = 2;

            doc.addPage();
            
            while (heightLeft > 0) {
                doc.addImage(imgData, 'PNG', margin, position + margin, imgWidth, imgHeight);
                heightLeft -= (pageHeight - margin * 2);
                addFooter(pageNum);
                if (heightLeft > 0) {
                    doc.addPage();
                    position = -heightLeft;
                    pageNum++;
                }
            }

            doc.save(filename);
            showToast('PDF generated successfully!', 'success');
        } catch (error) {
            console.error("PDF Export Error:", error);
            showToast('Failed to generate PDF.', 'error');
        } finally {
            exportPdfBtn.disabled = !campaignIdInput.value.trim();
            exportText.textContent = 'Export to PDF';
            exportSpinner.classList.add('hidden');
        }
    };


    // --- EVENT LISTENERS ---
    filtersContainer.addEventListener('change', e => {
        if (e.target.type === 'checkbox') {
            updatePillAppearance(e.target);
            
            // Special logic for Chaining -> Customer ID
            const isChaining = e.target.id === 'filter-conversions-Chaining';
            const customerIdCheckbox = document.getElementById('filter-datapoints-CustomerID');

            if (isChaining && e.target.checked) {
                customerIdCheckbox.checked = true;
                updatePillAppearance(customerIdCheckbox);
            }
            
            renderChecklist();
            if(isSaveOnChangeOn) debouncedSave();
        }
    });

    checklistBody.addEventListener('click', e => {
        // Status Pill Toggle
        const statusPill = e.target.closest('.status-pill-button');
        if (statusPill) {
            statusPill.classList.toggle('checked');
            const statusText = statusPill.querySelector('.status-text');
            statusText.textContent = statusPill.classList.contains('checked') ? 'Checked' : 'Not Checked';
            if(isSaveOnChangeOn) debouncedSave();
        }
        
        // Category Check/Uncheck All
        const checkAllBtn = e.target.closest('.check-all-btn');
        if (checkAllBtn) {
            const category = checkAllBtn.dataset.category;
            document.querySelectorAll(`tr[data-task]`).forEach(row => {
                const taskCategory = checklistData.find(d => d.task === row.dataset.task)?.category;
                if (taskCategory === category) {
                    const pill = row.querySelector('.status-pill-button');
                    pill.classList.add('checked');
                    pill.querySelector('.status-text').textContent = 'Checked';
                }
            });
            if(isSaveOnChangeOn) debouncedSave();
        }
        
        const uncheckAllBtn = e.target.closest('.uncheck-all-btn');
        if (uncheckAllBtn) {
            const category = uncheckAllBtn.dataset.category;
            document.querySelectorAll(`tr[data-task]`).forEach(row => {
                const taskCategory = checklistData.find(d => d.task === row.dataset.task)?.category;
                if (taskCategory === category) {
                    const pill = row.querySelector('.status-pill-button');
                    pill.classList.remove('checked');
                    pill.querySelector('.status-text').textContent = 'Not Checked';
                }
            });
            if(isSaveOnChangeOn) debouncedSave();
        }
    });

    checklistBody.addEventListener('input', e => {
        if (e.target.classList.contains('notes-input')) {
            autoResizeTextarea(e.target);
            if(isSaveOnChangeOn) debouncedSave();
        }
    });

    historyList.addEventListener('click', e => {
        const loadTarget = e.target.closest('div[data-id]');
        const deleteTarget = e.target.closest('.delete-checklist-btn');

        if(loadTarget && !deleteTarget) {
            const id = parseInt(loadTarget.dataset.id, 10);
            const checklist = getSavedChecklists().find(c => c.id === id);
            if(checklist) loadState(checklist);
        } else if (deleteTarget) {
            const id = parseInt(deleteTarget.dataset.id, 10);
            if (confirm('Are you sure you want to delete this checklist?')) {
                deleteChecklist(id);
            }
        }
    });

    [clientNameInput, accountIdInput, campaignIdInput].forEach(input => {
        input.addEventListener('input', () => {
             if(isSaveOnChangeOn) debouncedSave();
        });
    });

    campaignIdInput.addEventListener('input', () => {
        exportPdfBtn.disabled = !campaignIdInput.value.trim();
    });

    newChecklistBtn.addEventListener('click', () => {
        startNewChecklist();
        showToast('New checklist started.', 'info');
    });
    
    saveChecklistBtn.addEventListener('click', saveCurrentChecklist);

    autosaveToggleBtn.addEventListener('click', e => {
        if (e.target.tagName !== 'INPUT') {
            isAutoSaveOn ? stopAutoSave() : startAutoSave();
        }
    });
    autosaveIntervalInput.addEventListener('change', () => {
        if (isAutoSaveOn) {
            stopAutoSave();
            startAutoSave();
        }
    });
    saveOnChangeToggleBtn.addEventListener('click', () => {
        isSaveOnChangeOn ? stopSaveOnChange() : startSaveOnChange();
    });
    
    exportPdfBtn.addEventListener('click', exportToPDF);

    deleteAllBtn.addEventListener('click', () => {
        if (getSavedChecklists().length > 0 && confirm('Are you sure you want to delete ALL saved checklists? This action cannot be undone.')) {
            saveChecklists([]);
            renderHistory();
            if (currentLoadedChecklistId) {
                startNewChecklist();
            }
            showToast('All checklists have been deleted.', 'info');
        }
    });


    // --- INITIALIZATION ---
    renderFilters();
    renderChecklist();
    renderHistory();
});
</script>

</body>
</html>
